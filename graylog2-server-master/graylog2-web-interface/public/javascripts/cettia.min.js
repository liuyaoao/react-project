/* Cettia v1.0.0-Beta1 | http://cettia.io/projects/cettia-javascript-client/ | (c) 2015, The Cettia Project | http://www.apache.org/licenses/LICENSE-2.0 */
(function(h,m){if("function"===typeof define&&define.amd)define([],function(){return m(h)});else if("object"===typeof exports){var t=require("jsdom").jsdom().defaultView;t.WebSocket=require("ws");t.EventSource=require("eventsource");t.msgpack=require("msgpack-lite");t.traverse=require("traverse");module.exports=m(t)}else h.cettia=m(h)})(this,function(h){function m(a){var b,d,c,e,f,k,l=[],g=function(g,p){p=p||[];d=!a||[g,p];c=!0;k=e||0;e=0;for(f=l.length;k<f&&!b;k++)l[k].apply(g,p);c=!1};return{add:function(a){var k=
l.length;l.push(a);c?f=l.length:!b&&d&&!0!==d&&(e=k,g(d[0],d[1]))},remove:function(a){var e;for(e=0;e<l.length;e++)if(a===l[e]||a.guid&&a.guid===l[e].guid)c&&e<=f&&(f--,e<=k&&k--),l.splice(e--,1)},fire:function(e,f){b||c||a&&d||g(e,f)},lock:function(){b=!0},locked:function(){return!!b},unlock:function(){b=d=c=e=f=k=void 0}}}function t(a,b){var d={reconnect:function(e){return 2*(e||250)},transports:[E,F,G]};if(b)for(var c in b)d[c]=b[c];b=d;var e={},f={};e.on=function(e,a){var b;b=f[e];if(!b){if(f.message.locked())return this;
b=f[e]=m();b.order=f.message.order}b.add(a);return this};e.off=function(e,a){var b=f[e];b&&b.remove(a);return this};e.once=function(a,b){function c(){e.off(a,c);b.apply(e,arguments)}b.guid=b.guid||v++;c.guid=b.guid;return e.on(a,c)};e.fire=function(a){var b=f[a];b&&b.fire(e,C.call(arguments,1));return this};var k,l,q,x=0;e.open=function(){k=null;clearTimeout(l);f.connecting.unlock();f.open.unlock();return e.fire("connecting")};e.close=function(){b.reconnect=!1;clearTimeout(l);"connecting"===n?e.fire("close"):
"opened"===n&&k.close();return this};var p;b.name&&h.name&&(p=JSON.parse(h.name)[b.name]);var n;e.state=function(){return n};for(c in{connecting:1,open:1,close:1,waiting:1})f[c]=m(!0),f[c].order=v++;f.message=m(!1);f.message.order=f.open.order;e.on("connecting",function(){n="connecting";for(var c=Array.isArray(a)?C.call(a):[a],d=0;d<c.length;d++){var f=c[d]=g.stringifyURI(g.makeAbsolute(c[d]),{sid:p});/^https?:/.test(f)&&!g.parseURI(f).query.transport&&(c.splice(d,1,f.replace(/^http/,"ws"),g.stringifyURI(f,
{transport:"stream"}),g.stringifyURI(f,{transport:"longpoll"})),d+=2)}(function y(){function a(){f.off("close",y).close()}var d=c.shift();if(d){for(var f,n=0;n<b.transports.length&&!(f=b.transports[n](d,b));n++);f?(e.once("close",a),f.on("close",y).on("close",function(){e.off("close",a)}).on("text",function L(c){function d(a){var b,c=function(c){return function(d){b||(b=!0,e.send("reply",{id:a.id,data:d,exception:!c}))}},c=[a.type,a.data,a.reply?{resolve:c(!0),reject:c(!1)}:null];e.fire.apply(e,c)}
f.off("text",L);c=g.parseURI(c).query;p!==c.sid&&(p=c.sid,e.fire("new"));b.heartbeat=+c.heartbeat;b._heartbeat=+c._heartbeat||5E3;k=f.off("close",y);var n;k.on("text",function(a){n?d(JSON.parse(a)):n=!0}).on("binary",function(a){"object"!==typeof exports&&(a=new Uint8Array(a));d(h.msgpack.decode(a))}).on("error",function(a){e.fire("error",a)}).on("close",function(){e.fire("close")});e.off("close",a).fire("open")}).open()):y()}else e.fire("error",Error()).fire("close")})()}).on("new",function(){if(b.name){var a=
h.name?JSON.parse(h.name):{};a[b.name]=p;h.name=JSON.stringify(a)}}).on("open",function(){n="opened";var a;(function K(){a=setTimeout(function(){e.send("heartbeat").once("heartbeat",function(){clearTimeout(a);K()});a=setTimeout(function(){e.fire("error",Error("heartbeat"));k.close()},b._heartbeat)},b.heartbeat-b._heartbeat)})();e.once("close",function(){clearTimeout(a)});f.connecting.lock();l=q=null;x=0}).on("close",function(){n="closed";f.connecting.lock();f.open.lock();if(b.reconnect)e.once("close",
function(){q=b.reconnect.call(e,q,x);!1!==q&&(x++,l=setTimeout(function(){e.open()},q),e.fire("waiting",q,x))})}).on("waiting",function(){n="waiting"});var w={};e.send=function(a,c,b,d){if("opened"!==n)return e.fire("cache",[a,c,b,d]),this;a={id:v++,type:a,data:c,reply:!(!b&&!d)};a.reply&&(w[a.id]=[b,d]);var f=!1;if("object"===typeof exports)f=h.traverse(c).reduce(function(a,c){return a||Buffer.isBuffer(c)||global.ArrayBuffer.isView(c)},!1);else{var g=h.ArrayBuffer;g&&JSON.stringify(c,function(a,
c){f=f||g.isView(c);return c})}f?k.send(h.msgpack.encode(a)):k.send(JSON.stringify(a));return this};e.on("reply",function(a){w[a.id][+a.exception].call(e,a.data);delete w[a.id]});return e.open()}function H(a,b){var d=b&&b.timeout||3E3,c={open:function(){function a(){clearTimeout(b)}c.connect();var b=setTimeout(function(){c.fire("error",Error("timeout")).close()},d);c.on("open",a).on("close",a);return this}},e={open:m(!0),text:m(),binary:m(),error:m(),close:m(!0)};c.on=function(a,c){e[a].add(c);return this};
c.off=function(a,c){e[a].remove(c);return this};c.fire=function(a){e[a].fire(c,C.call(arguments,1));return this};var f=!1;c.on("open",function(){f=!0});c.on("close",function(){f=!1;for(var a in e)"close"!==a&&e[a].lock()});c.send=function(a){f?c.write(a):c.emit("error",Error("notopened"));return this};return c}function E(a,b){var d=h.WebSocket;if(d&&/^wss?:/.test(a)){var c,e=H(a,b);e.connect=function(){c=new d(a);c.binaryType="arraybuffer";c.onopen=function(){e.fire("open")};c.onmessage=function(a){"string"===
typeof a.data?e.fire("text",a.data):e.fire("binary",a.data)};c.onerror=function(){e.fire("error",Error()).fire("close")};c.onclose=function(){e.fire("close")}};e.write=function(a){c.send(a)};e.close=function(){c.close();return this};return e}}function I(a,b){var d=b&&b.xdrURL,c=H(a,b),e;c.on("open",function(){e=g.stringifyURI(a,{id:c.id})}).on("close",function(){e=null});var f=!1,k=[],l=function(){k.length?m(k.shift()):f=!1},q=function(){e&&c.fire("error",Error()).close()},m=!g.crossOrigin(a)||g.corsable?
function(a){var c=new z;c.onreadystatechange=function(){4===c.readyState&&(200===c.status?l():q())};c.open("POST",e);c.withCredentials=!0;"string"===typeof a?(c.setRequestHeader("Content-Type","text/plain; charset=UTF-8"),c.send("data="+a)):(c.setRequestHeader("Content-Type","application/octet-stream"),"object"===typeof exports&&(a=(new Uint8Array(a)).buffer),c.send(a));return this}:h.XDomainRequest&&d?function(a){var b=new h.XDomainRequest;b.onload=l;b.onerror=q;b.open("POST",d.call(c,e));b.send("data="+
a);return this}:function(a){var c=r.createElement("form");c.action=e;c.target="socket-"+v++;c.method="POST";c.enctype="text/plain";c.acceptCharset="UTF-8";c.style.display="none";c.innerHTML='<textarea name="data"></textarea><iframe name="'+c.target+'"></iframe>';c.firstChild.value=a;a=c.lastChild;g.on(a,"error",function(){q()});g.on(a,"load",function(){r.body.removeChild(c);l()});r.body.appendChild(c);c.submit();return this};c.write=function(a){f?k.push(a):(f=!0,m(a))};var p;c.close=function(){c.abort();
if(!p){p=!0;var b=r.createElement("script");b.async=!1;b.src=g.stringifyURI(a,{id:c.id,when:"abort"});b.onload=b.onerror=function(){b.parentNode&&b.parentNode.removeChild(b);c.fire("close")};r.head.appendChild(b)}return this};return c}function F(a,b){if(/^https?:/.test(a)&&"stream"===g.parseURI(a).query.transport)return M(a,b)||N(a,b)||O(a,b)||P(a,b)}function A(a,b){var d="",c=I(a,b);c.parse=function(a){if(a=a.replace(/^\s+/,"")){a=(d+a).split("\n\n");for(var b=0;b<a.length-1;b++)c.onmessage(a[b].substring(6));
d=a[a.length-1]}};var e;c.onmessage=function(a){if(e){var b=a.substring(0,1);a=a.substring(1);switch(b){case "1":c.fire("text",a);break;case "2":if("object"===typeof exports)a=new Buffer(a,"base64");else{b=atob(a);a=new Uint8Array(a.length);for(var d=0;d<b.length;d++)a[d]=b.charCodeAt(d);a=a.buffer}c.fire("binary",a)}}else e=!0,b=g.parseURI(a).query,c.id=b.id,c.fire("open")};return c}function M(a,b){var d=h.EventSource;if(d&&!(g.crossOrigin(a)&&g.browser.safari&&7>g.browser.vmajor)){var c,e=A(a,b);
e.connect=function(){c=new d(a+"&when=open&sse=true",{withCredentials:!0});c.onmessage=function(a){e.onmessage(a.data)};c.onerror=function(){c.close();e.fire("close")}};e.abort=function(){c.close()};return e}}function N(a,b){if(!(g.browser.msie&&10>g.browser.vmajor||g.crossOrigin(a)&&!g.corsable)){var d,c=A(a,b);c.connect=function(){var b;d=new z;d.onreadystatechange=function(){3===d.readyState&&200===d.status?(c.parse(b?d.responseText.substring(b):d.responseText),b=d.responseText.length):4===d.readyState&&
(200!==d.status&&c.fire("error",Error()),c.fire("close"))};d.open("GET",a+"&when=open");d.withCredentials=!0;d.send()};c.abort=function(){d.abort()};return c}}function O(a,b){var d=b&&b.xdrURL,c=h.XDomainRequest;if(d&&c){var e,f=A(a,b);f.connect=function(){var b;e=new c;e.onprogress=function(){f.parse(b?e.responseText.substring(b):e.responseText);b=e.responseText.length};e.onerror=function(){f.fire("error",Error()).fire("close")};e.onload=function(){f.fire("close")};e.open("GET",d.call(f,a+"&when=open"));
e.send()};f.abort=function(){e.abort()};return f}}function P(a,b){var d=h.ActiveXObject;if(d&&!g.crossOrigin(a)){var c,e,f=A(a,b);f.connect=function(){function b(a){var c;(function w(){c=setTimeout(function(){!1!==a()&&w()},1)})();return function(){clearTimeout(c)}}c=new d("htmlfile");c.open();c.close();var g=c.createElement("iframe");g.src=a+"&when=open";c.body.appendChild(g);var h=g.contentDocument||g.contentWindow.document;e=b(function(){function a(){var b=c.cloneNode(!0);b.appendChild(h.createTextNode("."));
b=b.innerText.replace(/\r\n/g,"\n");return b.substring(0,b.length-1)}if(h.firstChild){var c=h.body.lastChild;if(!c)return f.fire("error",Error()).fire("close"),!1;f.parse(a());c.innerText="";e=b(function(){var b=a();b&&(c.innerText="",f.parse(b));if("complete"===h.readyState)return f.fire("close"),!1});return!1}})};f.abort=function(){e();c.execCommand("Stop")};return f}}function G(a,b){if(/^https?:/.test(a)&&"longpoll"===g.parseURI(a).query.transport)return Q(a,b)||R(a,b)||S(a,b)}function D(a,b){var d=
I(a,b);d.connect=function(){d.poll(a+"&when=open",function(b){b=g.parseURI(b).query;d.id=b.id;(function f(){d.poll(g.stringifyURI(a,{id:d.id,when:"poll"}),function(a){a?(f(),"string"===typeof a?d.fire("text",a):("object"===typeof exports&&(a=new Buffer(new Uint8Array(a))),d.fire("binary",a))):d.fire("close")})})();d.fire("open")})};return d}function Q(a,b){if(!g.crossOrigin(a)||g.corsable){var d,c=D(a,b);c.poll=function(a,b){d=new z;d.onreadystatechange=function(){switch(d.readyState){case 2:"application/octet-stream"===
d.getResponseHeader("content-type")&&(d.responseType="arraybuffer");break;case 4:200===d.status?b(d.response||d.responseText):c.fire("error",Error()).fire("close")}};d.open("GET",a);d.withCredentials=!0;d.send(null)};c.abort=function(){d.abort()};return c}}function R(a,b){var d=b&&b.xdrURL,c=h.XDomainRequest;if(d&&c){var e,f=D(a,b);f.poll=function(a,b){a=d.call(f,a);e=new c;e.onload=function(){b(e.responseText)};e.onerror=function(){f.fire("error",Error()).fire("close")};e.open("GET",a);e.send()};
f.abort=function(){e.abort()};return f}}function S(a,b){var d,c=D(a,b),e=J.pop()||"socket_"+v++;c.on("close",function(){delete h[e];J.push(e)});c.poll=function(a,b){h[e]=function(a){b(a)};d=r.createElement("script");d.async=!0;d.src=g.stringifyURI(a,{jsonp:"true",callback:e});d.onload=d.onerror=function(a){d.parentNode&&d.parentNode.removeChild(d);"error"===a.type&&c.fire("error",Error()).fire("close")};r.head.appendChild(d)};c.abort=function(){d.parentNode&&d.parentNode.removeChild(d)};return c}
var v=1,C=Array.prototype.slice,r=h.document,B=h.location,T=h.navigator,z=h.XMLHttpRequest,g={makeAbsolute:function(a){var b=r.createElement("div");b.innerHTML='<a href="'+a+'"/>';return encodeURI(decodeURI(b.firstChild.href))},on:function(a,b,d){a.addEventListener?a.addEventListener(b,d,!1):a.attachEvent&&a.attachEvent("on"+b,d)},stringifyURI:function(a,b){var d,c=[];b=b||{};b._=v++;for(d in b)null!=b[d]&&c.push(encodeURIComponent(d)+"="+encodeURIComponent(b[d]));return a+(/\?/.test(a)?"&":"?")+
c.join("&").replace(/%20/g,"+")},parseURI:function(a){var b={query:{}};if(a=/.*\?([^#]*)/.exec(a)){a=a[1].split("&");for(var d=0;d<a.length;d++){var c=a[d].split("=");b.query[decodeURIComponent(c[0])]=decodeURIComponent(c[1]||"")}}return b}};g.corsable="withCredentials"in new z;g.browser=function(){var a=T.userAgent.toLowerCase(),b={},a=/(msie) ([\w.]+)/.exec(a)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(a)||0>a.indexOf("android")&&/version\/(.+) (safari)/.exec(a)||[];"safari"===a[2]&&(a[2]=a[1],a[1]=
"safari");b[a[1]||""]=!0;b.version=a[2]||"0";b.vmajor=b.version.split(".")[0];b.trident&&(b.msie=!0);return b}();g.crossOrigin=function(a){a=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(a.toLowerCase());return!(!a||a[1]==B.protocol&&a[2]==B.hostname&&(a[3]||("http:"===a[1]?80:443))==(B.port||("http:"===B.protocol?80:443)))};var J=[],u=[];g.on(h,"unload",function(){for(var a,b=0;b<u.length;b++)a=u[b],"closed"!==a.state()&&a.close()});g.on(h,"online",function(){for(var a,b=0;b<u.length;b++)a=
u[b],"waiting"===a.state()&&a.open()});g.on(h,"offline",function(){for(var a,b=0;b<u.length;b++)a=u[b],"opened"===a.state()&&a.fire("error",Error()).fire("close")});return{open:function(a,b){var d=t(a,b);u.push(d);return d},transport:{createWebSocketTransport:E,createHttpStreamTransport:F,createHttpLongpollTransport:G},util:g}});
